<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æš—è¨˜ã‚«ãƒ¼ãƒ‰è‡ªå‹•ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f8fbff;
      --panel: rgba(255,255,255,0.75);
      --ink: #1f2a44;
      --sub: #546285;
      --accent: #6e8bff;
      --accent-2: #ff7ac2;
      --ok: #2cc5a3;
      --warn:#ffae55;
      --radius: 18px;
      --shadow: 0 20px 40px rgba(0,0,0,.08);
    }
    *{ box-sizing:border-box }
    body{
      margin:0; color:var(--ink); background: linear-gradient(135deg,#f7f5ff, #ecfbff 40%, #fffaf2);
      font-family: 'Noto Sans JP', 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      position:sticky; top:0; backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.6));
      border-bottom: 1px solid rgba(0,0,0,.06);
      z-index:10;
    }
    .container{ max-width:1100px; width:100%; margin:0 auto; padding: 16px 20px; }
    .row{ display:flex; gap:16px; flex-wrap:wrap; align-items:center; }
    h1{
      margin:0; letter-spacing:.02em; display:flex; align-items:center; gap:10px;
      font-weight:700; font-size: clamp(20px, 2.4vw, 28px);
    }
    .badge{
      font-size:12px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff;
      padding:4px 10px; border-radius: 999px; box-shadow: var(--shadow);
    }
    .panel{
      background: var(--panel); border:1px solid rgba(0,0,0,.06); border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .toolbar{ display:flex; gap:12px; align-items:stretch; flex-wrap:wrap; }
    select, input[type="text"], textarea{
      width:100%; border:1px solid rgba(0,0,0,.08); background:#fff; color:var(--ink);
      border-radius:12px; padding:12px 14px; outline:none; transition:.2s;
    }
    select:focus, input:focus, textarea:focus{ border-color: var(--accent); box-shadow: 0 0 0 4px rgba(110,139,255,.15) }
    button{
      border:none; padding:12px 14px; border-radius:12px; cursor:pointer; font-weight:600;
      background:#fff; color:var(--ink); border:1px solid rgba(0,0,0,.08); transition:.2s;
    }
    button:hover{ transform: translateY(-1px); box-shadow: var(--shadow) }
    .btn-primary{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; border:none }
    .btn-ghost{ background: transparent; border: 1px dashed rgba(0,0,0,.2) }
    .spacer{ flex:1 }

    /* Tabs */
    .tabs{ display:flex; gap:8px; margin-top:14px }
    .tab{ padding:10px 14px; border-radius:999px; background:#fff; border:1px solid rgba(0,0,0,.06); cursor:pointer; font-weight:600 }
    .tab.active{ background:linear-gradient(135deg,#fff, #f2f6ff); border-color: var(--accent); box-shadow: 0 6px 20px rgba(110,139,255,.2) }

    main{ flex:1 }
    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:20px; padding:20px }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr } }

    /* Creator */
    .creator .section{ padding:16px; }
    .creator .two{ display:grid; grid-template-columns: 1fr 1fr; gap:12px }

    .list .item{ display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:center; padding:10px; border-radius:12px; border:1px solid rgba(0,0,0,.06); background:#fff }
    .list .item input{ padding:8px 10px }

    /* Study Card */
    .study-wrap{ display:flex; flex-direction:column; gap:16px; align-items:center; padding:16px }
    .card3d{ width:min(580px, 95%); height:330px; perspective:1200px }
    .card-inner{ position:relative; width:100%; height:100%; transform-style:preserve-3d; transition: transform .6s cubic-bezier(.2,.8,.2,1) }
    .card-inner.flipped{ transform: rotateY(180deg) }
    .face{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; text-align:center; padding:26px; backface-visibility:hidden; border-radius:20px; border:1px solid rgba(0,0,0,.06); background:linear-gradient(180deg,#fff, #f7f9ff) }
    .back{ transform: rotateY(180deg) }
    .face h2{ font-size: clamp(20px, 2.2vw, 26px); margin:0 }

    .study-controls{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center }
    .pill{ padding:8px 12px; border-radius:999px; background:#fff; border:1px solid rgba(0,0,0,.08); font-size:12px; color:var(--sub) }

    .foot{ text-align:center; color:var(--sub); font-size:12px; padding:10px 0 24px }
    .link{ color: var(--accent); font-weight:600; text-decoration: none }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <h1>ğŸ“š æš—è¨˜ã‚«ãƒ¼ãƒ‰è‡ªå‹•ãƒ¡ãƒ¼ã‚«ãƒ¼ <span class="badge">flip & random</span></h1>
        <div class="spacer"></div>
        <div class="toolbar">
          <label style="font-size:12px;color:var(--sub);display:block">æ•™ç§‘ï¼ˆç§‘ç›®ï¼‰</label>
          <select id="subjectSelect"></select>
          <button id="addSubjectBtn">ï¼‹ æ•™ç§‘ã‚’è¿½åŠ </button>
          <button id="renameSubjectBtn">æ•™ç§‘åã®å¤‰æ›´</button>
          <button id="removeSubjectBtn" class="btn-ghost">æ•™ç§‘ã‚’å‰Šé™¤</button>
        </div>
        <div class="tabs">
          <div class="tab active" data-tab="create">ã‚«ãƒ¼ãƒ‰ä½œæˆ</div>
          <div class="tab" data-tab="study">å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰</div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <!-- Left: Creator / Study -->
      <section class="panel creator" id="tab-create">
        <div class="section">
          <h3 style="margin:0 0 8px">â‘  å˜èªã‚’å…¥ã‚Œã¦ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ</h3>
          <p style="color:var(--sub);margin-top:0">è¡¨ï¼ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€è£ï¼ç­”ãˆã€‚Enterã§ã‚µã‚¯ãƒƒã¨è¿½åŠ ã§ãã¾ã™ã€‚</p>
          <div class="two">
            <input id="qInput" type="text" placeholder="ä¾‹ï¼‰photosynthesisï¼ˆå…‰åˆæˆï¼‰" />
            <input id="aInput" type="text" placeholder="ä¾‹ï¼‰æ¤ç‰©ãŒå…‰ã§æ „é¤Šã‚’ä½œã‚‹ã¯ãŸã‚‰ã" />
          </div>
          <div style="margin-top:10px; display:flex; gap:10px; align-items:center">
            <button class="btn-primary" id="addCardBtn">ï¼‹ ã‚«ãƒ¼ãƒ‰è¿½åŠ ï¼ˆEnterï¼‰</button>
            <span class="pill">åˆè¨ˆ <span id="countSpan">0</span> æš</span>
            <div class="spacer"></div>
            <button id="exportBtn">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <label for="importFile" class="btn-ghost" style="cursor:pointer">JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ</label>
            <input id="importFile" type="file" accept="application/json" style="display:none"/>
          </div>
        </div>
        <hr style="border:none;border-top:1px solid rgba(0,0,0,.08)">
        <div class="section">
          <h3 style="margin:0 0 8px">â‘¡ ã¾ã¨ã‚ã¦è¿½åŠ ï¼ˆè¡Œã”ã¨ï¼‰</h3>
          <p style="color:var(--sub);margin-top:0">ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ : ç­”ãˆã€å½¢å¼ã§1è¡Œã«1ã‚»ãƒƒãƒˆã€‚ä¾‹ï¼‰<code>atom : ç‰©è³ªã‚’ã¤ãã‚‹æœ€å°ã®ç²’</code></p>
          <textarea id="bulkArea" rows="6" placeholder="river : å·\nmountain : å±±\n..."></textarea>
          <div style="margin-top:10px; display:flex; gap:10px">
            <button id="bulkAddBtn">â†‘ ã“ã®å†…å®¹ã‚’ã‚«ãƒ¼ãƒ‰ã«å¤‰æ›</button>
            <button id="bulkClearBtn">å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
          </div>
        </div>
        <hr style="border:none;border-top:1px solid rgba(0,0,0,.08)">
        <div class="section">
          <h3 style="margin:0 0 8px">â‘¢ ã‚«ãƒ¼ãƒ‰ä¸€è¦§ï¼ˆç·¨é›†ãƒ»å‰Šé™¤OKï¼‰</h3>
          <div id="list" class="list" style="display:flex; flex-direction:column; gap:10px"></div>
        </div>
      </section>

      <!-- Right: Study -->
      <section class="panel" id="tab-study" style="display:none">
        <div class="study-wrap">
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center">
            <button id="startStudyBtn" class="btn-primary">å­¦ç¿’é–‹å§‹</button>
            <button id="shuffleBtn">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
            <button id="prevBtn">â† å‰ã¸</button>
            <button id="flipBtn">ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹ï¼ˆSpaceï¼‰</button>
            <button id="nextBtn">æ¬¡ã¸ â†’</button>
            <button id="randomBtn">ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œï¼ˆRï¼‰</button>
          </div>
          <div class="card3d" id="card3d">
            <div class="card-inner" id="cardInner">
              <div class="face front"><h2 id="frontText">ã“ã“ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h2></div>
              <div class="face back"><h2 id="backText">ã“ã“ã«ç­”ãˆ</h2></div>
            </div>
          </div>
          <div class="study-controls">
            <span class="pill">æ•™ç§‘ï¼š<b id="subjName">-</b></span>
            <span class="pill">æšæ•°ï¼š<b id="totalSpan">0</b></span>
            <span class="pill">ä»Šï¼š<b id="indexSpan">0</b> / <b id="total2Span">0</b></span>
            <span class="pill">æ­£è§£ç‡ï¼š<b id="rateSpan">0%</b></span>
          </div>
          <div style="font-size:12px;color:var(--sub)">ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚ã‚ãã‚Œã¾ã™ã€‚ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼šSpace=ã‚ãã‚‹ã€â†/â†’=ç§»å‹•ã€R=ãƒ©ãƒ³ãƒ€ãƒ </div>
        </div>
      </section>

      <!-- Right column: Tips -->
      <aside class="panel" style="padding:16px">
        <h3 style="margin-top:0">ä½¿ã„æ–¹</h3>
        <ol>
          <li>ä¸Šã®ã€Œæ•™ç§‘ã€ã‚’é¸ã¶ã‹ã€è¿½åŠ ã—ã¾ã™ã€‚</li>
          <li>â‘ ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ç­”ãˆã‚’å…¥ã‚Œã¦ã€Œã‚«ãƒ¼ãƒ‰è¿½åŠ ã€ã€‚</li>
          <li>ãŸãã•ã‚“ã‚ã‚‹æ™‚ã¯â‘¡ã®ãƒ†ã‚­ã‚¹ãƒˆã«ã¾ã¨ã‚ã¦è²¼ã£ã¦ã€Œå¤‰æ›ã€ã€‚</li>
          <li>â‘¢ã§ç›´ã—ãŸã‚Šã€ã„ã‚‰ãªã„ã‚«ãƒ¼ãƒ‰ã¯ğŸ—‘ï¸ã§å‰Šé™¤ã€‚</li>
          <li>ã€Œå­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã€ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã‹Spaceã§ã‚ãã‚‹ã‚ˆã€‚</li>
        </ol>
        <p class="pill">ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«è‡ªå‹•ä¿å­˜ï¼ˆlocalStorageï¼‰ã€‚ãƒ‘ã‚½ã‚³ãƒ³ã‚’é–‰ã˜ã¦ã‚‚æ®‹ã‚Šã¾ã™ã€‚</p>
        <p style="color:var(--sub)">SNSã«å…±æœ‰ã—ãŸã„æ™‚ã¯ã€ŒJSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜â†’åˆ¥ã®PCã§ã€ŒJSONã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã€‚</p>
        <hr style="border:none;border-top:1px solid rgba(0,0,0,.08)">
        <h4>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h4>
        <ul>
          <li>Enterï¼šã‚«ãƒ¼ãƒ‰è¿½åŠ </li>
          <li>Spaceï¼šã‚ãã‚‹</li>
          <li>â†/â†’ï¼šç§»å‹•</li>
          <li>Rï¼šãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ</li>
        </ul>
      </aside>
    </div>
  </main>

  <div class="foot">Made with â™¥ / ä¿å­˜å…ˆï¼šbrowser localStorage / v1.0</div>

  <script>
    // ====== æ°¸ç¶šåŒ–ï¼ˆlocalStorageï¼‰ ======
    const STORAGE_KEY = 'anki_db_v1';
    const initialDB = { subjects: { 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ': [] }, lastSubject: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ' };
    let db = loadDB();
    function loadDB(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw){ localStorage.setItem(STORAGE_KEY, JSON.stringify(initialDB)); return structuredClone(initialDB); }
        const parsed = JSON.parse(raw);
        if(!parsed.subjects) parsed.subjects = { 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ': [] };
        if(!parsed.lastSubject) parsed.lastSubject = Object.keys(parsed.subjects)[0] || 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ';
        return parsed;
      }catch(e){ console.error(e); return structuredClone(initialDB) }
    }
    function saveDB(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)) }

    // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
    const $ = s => document.querySelector(s);
    const el = (tag, attrs={}, children=[]) => {
      const x = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{ if(k==='class') x.className=v; else if(k==='html') x.innerHTML=v; else x.setAttribute(k,v) });
      children.forEach(c=> x.appendChild(c));
      return x;
    }
    const uid = () => Math.random().toString(36).slice(2,9);

    // ====== æ•™ç§‘ï¼ˆç§‘ç›®ï¼‰ç®¡ç† ======
    const subjectSelect = $('#subjectSelect');
    function refreshSubjects(){
      subjectSelect.innerHTML='';
      Object.keys(db.subjects).forEach(name=>{
        const opt = el('option',{ value:name }); opt.textContent = name; subjectSelect.appendChild(opt);
      });
      if(!db.subjects[db.lastSubject]) db.lastSubject = Object.keys(db.subjects)[0] || 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ';
      subjectSelect.value = db.lastSubject;
      $('#subjName').textContent = db.lastSubject;
      renderList(); updateCounters();
    }
    function ensureSubject(name){ if(!db.subjects[name]) db.subjects[name] = [] }

    // Add/Rename/Remove Subject
    $('#addSubjectBtn').addEventListener('click', ()=>{
      const name = prompt('æ–°ã—ã„æ•™ç§‘åã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼ˆä¾‹ï¼šè‹±èªã€ç†ç§‘ï¼‰');
      if(!name) return;
      if(db.subjects[name]) return alert('åŒã˜åå‰ãŒæ—¢ã«ã‚ã‚Šã¾ã™');
      db.subjects[name] = [];
      db.lastSubject = name; saveDB(); refreshSubjects();
    });
    $('#renameSubjectBtn').addEventListener('click', ()=>{
      const cur = subjectSelect.value;
      const name = prompt('æ•™ç§‘åã‚’å¤‰æ›´', cur);
      if(!name || name===cur) return;
      if(db.subjects[name]) return alert('ãã®åå‰ã¯ä½¿ãˆã¾ã›ã‚“');
      db.subjects[name] = db.subjects[cur]; delete db.subjects[cur];
      db.lastSubject = name; saveDB(); refreshSubjects();
    });
    $('#removeSubjectBtn').addEventListener('click', ()=>{
      const cur = subjectSelect.value;
      if(!confirm(`ã€Œ${cur}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚«ãƒ¼ãƒ‰ã‚‚æ¶ˆãˆã¾ã™ï¼‰`)) return;
      delete db.subjects[cur];
      if(Object.keys(db.subjects).length===0){ db.subjects['ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ']=[]; db.lastSubject='ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'; }
      else { db.lastSubject = Object.keys(db.subjects)[0]; }
      saveDB(); refreshSubjects();
    });
    subjectSelect.addEventListener('change', ()=>{ db.lastSubject = subjectSelect.value; saveDB(); refreshSubjects(); })

    // ====== ã‚«ãƒ¼ãƒ‰ä½œæˆãƒ»ä¸€è¦§ ======
    const qInput = $('#qInput');
    const aInput = $('#aInput');
    const listDiv = $('#list');

    function addCard(q,a){
      const subj = db.lastSubject; ensureSubject(subj);
      if(!q.trim() || !a.trim()) return;
      db.subjects[subj].push({ id: uid(), q: q.trim(), a: a.trim() });
      saveDB(); renderList(); updateCounters();
      qInput.value=''; aInput.value=''; qInput.focus();
    }

    function renderList(){
      const subj = db.lastSubject; ensureSubject(subj);
      listDiv.innerHTML='';
      db.subjects[subj].forEach(item=>{
        const qi = el('input', { type:'text', value:item.q });
        const ai = el('input', { type:'text', value:item.a });
        const del = el('button'); del.textContent='ğŸ—‘ï¸';
        del.addEventListener('click', ()=>{ if(confirm('å‰Šé™¤ã—ã¦ã‚ˆã„ï¼Ÿ')){ db.subjects[subj] = db.subjects[subj].filter(x=>x.id!==item.id); saveDB(); renderList(); updateCounters(); }});
        qi.addEventListener('change', ()=>{ item.q = qi.value; saveDB() });
        ai.addEventListener('change', ()=>{ item.a = ai.value; saveDB() });
        const row = el('div', { class:'item' }, [qi,ai,del]);
        listDiv.appendChild(row);
      })
      if(db.subjects[subj].length===0){
        listDiv.appendChild(el('div',{class:'item', html:'<em>ã¾ã ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã—ã¦ã­ã€‚</em>'}))
      }
    }

    $('#addCardBtn').addEventListener('click', ()=> addCard(qInput.value, aInput.value));
    qInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ addCard(qInput.value, aInput.value) } });
    aInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ addCard(qInput.value, aInput.value) } });

    // Bulk add
    $('#bulkAddBtn').addEventListener('click', ()=>{
      const text = $('#bulkArea').value; if(!text.trim()) return;
      const lines = text.split(/\n+/);
      let ok=0, ng=0;
      lines.forEach(line=>{
        const m = line.split(/\s*[:ï¼š]\s*/); // ã€Œ:ã€ã¾ãŸã¯ã€Œï¼šã€
        if(m.length>=2){ addCard(m[0], m.slice(1).join(':')); ok++; }
        else if(line.trim()){ ng++; }
      });
      alert(`è¿½åŠ ï¼š${ok}ä»¶\nå½¢å¼ã‚¨ãƒ©ãƒ¼ï¼š${ng}ä»¶`);
    });
    $('#bulkClearBtn').addEventListener('click', ()=> $('#bulkArea').value='');

    // Export / Import
    $('#exportBtn').addEventListener('click', ()=>{
      const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(db));
      const a = el('a', { href:dataStr, download:'anki-data.json' });
      document.body.appendChild(a); a.click(); a.remove();
    });
    $('#importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const imported = JSON.parse(reader.result);
          if(!imported.subjects) throw new Error('å½¢å¼ãŒé•ã„ã¾ã™');
          db = imported; saveDB(); refreshSubjects(); alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼');
        }catch(err){ alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼š' + err.message) }
      }
      reader.readAsText(file);
      e.target.value='';
    })

    // ====== å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ ======
    const tabs = document.querySelectorAll('.tab');
    const tabCreate = $('#tab-create');
    const tabStudy  = $('#tab-study');
    tabs.forEach(t=> t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      if(t.dataset.tab==='create'){ tabCreate.style.display='block'; tabStudy.style.display='none'; }
      else { tabCreate.style.display='none'; tabStudy.style.display='block'; }
    }));

    let study = { list:[], i:0, flipped:false, correct:0, tried:0 };

    function startStudy(){
      const subj = db.lastSubject; const arr = db.subjects[subj]||[];
      if(arr.length===0){ alert('ã“ã®æ•™ç§‘ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      study = { list: arr.map(x=>({...x})), i:0, flipped:false, correct:0, tried:0 };
      updateStudyCard();
      updateStats();
    }

    function updateStudyCard(){
      const cur = study.list[study.i];
      $('#frontText').textContent = cur ? cur.q : 'â€”';
      $('#backText').textContent  = cur ? cur.a : 'â€”';
      $('#cardInner').classList.toggle('flipped', study.flipped);
      $('#subjName').textContent = db.lastSubject;
      $('#totalSpan').textContent = study.list.length;
      $('#indexSpan').textContent = (study.i+1);
      $('#total2Span').textContent = study.list.length;
    }

    function updateStats(){
      const rate = study.tried ? Math.round(100*study.correct/study.tried) : 0;
      $('#rateSpan').textContent = rate + '%';
    }

    function flip(){ study.flipped = !study.flipped; updateStudyCard(); }
    function next(rand=false){
      if(study.list.length===0) return;
      if(rand){ study.i = Math.floor(Math.random()*study.list.length) }
      else { study.i = (study.i + 1) % study.list.length }
      study.flipped = false; updateStudyCard();
    }
    function prev(){ if(study.list.length===0) return; study.i = (study.i - 1 + study.list.length) % study.list.length; study.flipped=false; updateStudyCard(); }
    function shuffle(){ study.list.sort(()=> Math.random() - .5); study.i=0; study.flipped=false; updateStudyCard(); }

    // UI handlers
    $('#startStudyBtn').addEventListener('click', startStudy);
    $('#flipBtn').addEventListener('click', flip);
    $('#nextBtn').addEventListener('click', ()=> next(false));
    $('#prevBtn').addEventListener('click', prev);
    $('#randomBtn').addEventListener('click', ()=> next(true));
    $('#shuffleBtn').addEventListener('click', shuffle);
    $('#card3d').addEventListener('click', flip);

    // ã‚­ãƒ¼æ“ä½œ
    window.addEventListener('keydown', (e)=>{
      if(tabStudy.style.display==='none') return;
      if(e.code==='Space'){ e.preventDefault(); flip(); }
      else if(e.key==='ArrowRight'){ next(false) }
      else if(e.key==='ArrowLeft'){ prev() }
      else if(e.key.toLowerCase()==='r'){ next(true) }
      else if(e.key.toLowerCase()==='s'){ shuffle() }
    })

    function updateCounters(){ $('#countSpan').textContent = (db.subjects[db.lastSubject]||[]).length }

    // åˆæœŸè¡¨ç¤º
    refreshSubjects();
  </script>
</body>
</html>
